{%- macro format_float(value) -%}
{{ "%.2f" % value }}
{%- endmacro -%}

{%- macro render_address(address) -%}
<Indirizzo>{{ address.address_line1 }}</Indirizzo>
<CAP>{{ address.pincode }}</CAP>
<Comune>{{ address.city }}</Comune>
{%- if address.state %}
<Provincia>{{ address.state }}</Provincia>
{%- endif %}
<Nazione>{{ address.country_code }}</Nazione>
{%- endmacro -%}
<?xml version='1.0' encoding='UTF-8'?>
<p:FatturaElettronica xmlns:ds="http://www.w3.org/2000/09/xmldsig#" 
  xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  versione="{{ doc.transmission_format_code }}" 
  xsi:schemaLocation="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2 http://www.fatturapa.gov.it/export/fatturazione/sdi/fatturapa/v1.2/Schema_del_file_xml_FatturaPA_versione_1.2.xsd">
  <FatturaElettronicaHeader>
    <DatiTrasmissione>
      <IdTrasmittente>
        <IdPaese>{{ doc.company_address_data.country_code }}</IdPaese>
        <IdCodice>{{ doc.company_fiscal_code or doc.company_tax_id | replace("IT","") }}</IdCodice>
      </IdTrasmittente>
      {%- if doc.company_fiscal_code %}
        <CodiceFiscale>{{ doc.company_fiscal_code }}</CodiceFiscale>
      {%- endif %}
      <ProgressivoInvio>{{ doc.progressive_number }}</ProgressivoInvio>
      <FormatoTrasmissione>{{ doc.transmission_format_code }}</FormatoTrasmissione>
      <CodiceDestinatario>{{ doc.customer_data.recipient_code }}</CodiceDestinatario>
      {%- if doc.company_contact_data.phone or doc.company_contact_data.email -%}
      <ContattiTrasmittente>
        {%- if doc.company_contact_data.phone_no -%}<Telefono>{{ doc.company_contact_data.phone_no }}</Telefono>{%- endif -%}
        {%- if doc.company_contact_data.email -%}<Email>{{ doc.company_contact_data.email }}</Email>{%- endif -%}
      </ContattiTrasmittente>
      {%- endif %}
    </DatiTrasmissione>
    <CedentePrestatore>
      <DatiAnagrafici>
        <IdFiscaleIVA>
          <IdPaese>{{ doc.company_address_data.country_code }}</IdPaese>
          <IdCodice>{{ doc.company_tax_id | replace("IT","") }}</IdCodice>
        </IdFiscaleIVA>
        {%- if doc.company_fiscal_code %}
        <CodiceFiscale>{{ doc.company_fiscal_code }}</CodiceFiscale>
        {%- endif %}
        <Anagrafica>
          <Denominazione>{{ doc.company }}</Denominazione>
        </Anagrafica>
        <RegimeFiscale>{{ doc.fiscal_regime.split("-")[0] }}</RegimeFiscale>
      </DatiAnagrafici>
      <Sede>
      {{ render_address(doc.company_address_data) }}
      </Sede>
    </CedentePrestatore>
    <CessionarioCommittente>
      <DatiAnagrafici>
        {%- if doc.customer_data.customer_type == "Individual" %}
        {%- if doc.customer_data.tax_id %}
        <IdFiscaleIVA>
          <IdPaese>{{ doc.customer_address_data.country_code }}</IdPaese>
          <IdCodice>{{ doc.tax_id | replace("IT","") }}</IdCodice>
        </IdFiscaleIVA>
        {%- endif %}
        <CodiceFiscale>{{ doc.customer_data.fiscal_code }}</CodiceFiscale>
        <Anagrafica>
          <Nome>{{ doc.customer_data.first_name }}</Nome>
          <Cognome>{{ doc.customer_data.last_name }}</Cognome>
        </Anagrafica>
        {%- else %}
        <IdFiscaleIVA>
          <IdPaese>{{ doc.customer_address_data.country_code }}</IdPaese>
          <IdCodice>{{ doc.tax_id | replace("IT","") }}</IdCodice>
        </IdFiscaleIVA>
        <Anagrafica>
          <Denominazione>{{ doc.customer_name }}</Denominazione>
        </Anagrafica>
        {%- endif %}
      </DatiAnagrafici>
      {%- if doc.customer_address_data %}
      <Sede>
      {{ render_address(doc.customer_address_data) }}
      </Sede>
      {%- endif %}
    </CessionarioCommittente>
  </FatturaElettronicaHeader>
  <FatturaElettronicaBody>
    <DatiGenerali>
      <DatiGeneraliDocumento>
        <TipoDocumento>{{ doc.type_of_document }}</TipoDocumento>
        <Divisa>EUR</Divisa>
        <Data>{{ doc.posting_date }}</Data>
        <Numero>{{ doc.progressive_number }}</Numero>
        <ImportoTotaleDocumento>{{ format_float(doc.grand_total) }}</ImportoTotaleDocumento>
        <Causale>VENDITA</Causale>
        {%- if doc.additional_discount_percentage or doc.additional_discount_amount %}
        <ScontoMaggiorazione>
          <Tipo>SC</Tipo>
          {%- if doc.additional_discount_percentage -%}<Percentuale>{{ doc.additional_discount_percentage }}</Percentuale>{%- endif -%}
          {%- if doc.additional_discount_amount -%}<Importo>{{ doc.additional_discount_amount }}</Percentuale>{%- endif -%}
        </ScontoMaggiorazione>
        {%- endif %}
      </DatiGeneraliDocumento>
      {%- if doc.po_no %}
      <DatiOrdineAcquisto>
        <IdDocumento>{{ doc.po_no }}</IdDocumento>
        {%- if doc.po_date %}
        <Data>{{ doc.po_date }}</Data>
        {%- endif %}
      </DatiOrdineAcquisto>
      {%- endif %}
      {%- if doc.shipping_address_data %}
      <DatiTrasporto>
      <IndirizzoResa>
        {{ render_address(doc.shipping_address_data) }}
      </IndirizzoResa>
      </DatiTrasporto>
      {%- endif %}
    </DatiGenerali>
    <DatiBeniServizi>
      {%- for item in doc.invoice_items %}
      <DettaglioLinee>
        <NumeroLinea>{{ item.idx }}</NumeroLinea>
        <CodiceArticolo>
          <CodiceTipo>CODICE</CodiceTipo>
          <CodiceValore>{{ item.item_code }}</CodiceValore>
        </CodiceArticolo>
        <Descrizione>{{ item.description or item.item_name }}</Descrizione>
        <Quantita>{{ format_float(item.qty) }}</Quantita>
        <UnitaMisura>{{ item.stock_uom }}</UnitaMisura>
        {%- if item.discount_percentage  %}
        <ScontoMaggiorazione>
          <Tipo>SC</Tipo>
          <Percentuale>{{ item.discount_percentage }}</Percentuale>
        </ScontoMaggiorazione>
        {%- endif %}
        <PrezzoUnitario>{{ format_float(item.net_rate) }}</PrezzoUnitario>
        <PrezzoTotale>{{ format_float(item.net_amount) }}</PrezzoTotale>
        <AliquotaIVA>{{ format_float(item.tax_rate) }}</AliquotaIVA>
        {%- if item.tax_exemption_reason %}
        <Natura>{{ item.tax_exemption_reason.split("-")[0] }}</Natura>
        {%- endif %}
      </DettaglioLinee>
      {%- endfor %}
      {%- for tax, data in doc.tax_data.items() %}
      <DatiRiepilogo>
        <AliquotaIVA>{{ format_float(data.tax_rate) }}</AliquotaIVA>
        {%- if data.tax_exemption_reason %}
        <Natura>{{ data.tax_exemption_reason.split("-")[0] }}</Natura>
        {%- endif %}
        <ImponibileImporto>{{ format_float(data.taxable_amount) }}</ImponibileImporto>
        <Imposta>{{ format_float(data.tax_amount) }}</Imposta>
        <EsigibilitaIVA>{{ doc.vat_collectability.split("-")[0] }}</EsigibilitaIVA>
      </DatiRiepilogo>
      {%- endfor %}
    </DatiBeniServizi>
    {%- if doc.payment_terms %}
    <DatiPagamento>
      {%- if payment_terms|length > 1 %}
      <CondizioniPagamento>TP01</CondizioniPagamento>
      {%- else %}
      <CondizioniPagamento>TP02</CondizioniPagamento>
      {%- endif %}
      {%- for payment_term in doc.payment_terms %}
      <DettaglioPagamento>
        <ModalitaPagamento>{{ payment_term.mode_of_payment_code }}</ModalitaPagamento>
        <ImportoPagamento>{{ payment_term.payment_amount }}</ImportoPagamento>
        <DataScadenzaPagamento>{{ payment_term.due_date }}</DataScadenzaPagamento>
        {%- if payment_term.iban %}<IBAN>{{ payment_term.bank_account_iban }}</IBAN>{%- endif %}
      </DettaglioPagamento>
      {%- endfor %}
    </DatiPagamento>
    {%- endif %}
  </FatturaElettronicaBody>
</p:FatturaElettronica>
